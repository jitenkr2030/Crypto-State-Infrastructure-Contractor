# 数据流架构设计

## 概述

本文档描述CSIC平台的数据流架构，包括数据采集、处理、存储和分析的完整流程。

## 数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据源层                                        │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────────────┤
│  区块链节点   │   交易所API  │  挖矿设备    │  能源系统    │    用户操作         │
│  (BTC/ETH)   │   (实时流)   │  (遥测数据)  │  (电网数据)  │    (审计日志)       │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────────┬──────────┘
       │             │             │             │                  │
       ▼             ▼             ▼             ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据采集层                                        │
├─────────────────────┬─────────────────────┬─────────────────────┬───────────┤
│  区块链适配器         │   交易所数据网关      │   设备通信协议        │   审计采集  │
│  (Bitcoin/Ethereum) │   (Kafka Producer)  │   (MQTT/Modbus)     │   (WORM)   │
└──────────┬──────────┴──────────┬──────────┴──────────┬──────────┴────┬───────┘
           │                     │                     │                │
           ▼                     ▼                     ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            消息队列层                                        │
│                           Apache Kafka                                       │
├─────────────────────┬─────────────────────┬─────────────────────┬───────────┤
│  transactions       │   exchange_data     │   mining_metrics    │  audit    │
│  (交易流)            │   (交易所流)         │   (挖矿流)          │  (审计流)  │
└──────────┬──────────┴──────────┬──────────┴──────────┬──────────┴────┬───────┘
           │                     │                     │                │
           ▼                     ▼                     ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            处理引擎层                                        │
├─────────────────────┬─────────────────────┬─────────────────────┬───────────┤
│  交易分析引擎        │   市场监控引擎       │   风险评估引擎       │   审计引擎 │
│  (流处理)           │   (实时规则)         │   (机器学习)        │   (WORM)  │
└──────────┬──────────┴──────────┬──────────┴──────────┬──────────┴────┬───────┘
           │                     │                     │                │
           ▼                     ▼                     ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            存储层                                            │
├─────────────────────┬─────────────────────┬─────────────────────┬───────────┤
│  PostgreSQL         │   TimescaleDB       │   OpenSearch        │  WORM     │
│  (交易/用户/配置)    │   (时序指标)         │   (日志/搜索)       │  (审计)    │
└──────────┬──────────┴──────────┬──────────┴──────────┬──────────┴────┬───────┘
           │                     │                     │                │
           └─────────────────────┴─────────────────────┴────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            服务层                                            │
├─────────────────────┬─────────────────────┬─────────────────────┬───────────┤
│  API Gateway        │   报表服务          │   告警服务          │   监管API  │
│  (REST/gRPC)        │   (PDF/CSV)         │   (通知)           │   (查询)   │
└─────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            访问层                                            │
├─────────────────────┬─────────────────────┬─────────────────────┬───────────┤
│  管理控制台          │   监管报表导出       │   告警通知          │   API调用  │
│  (React Admin)      │   (PDF/Excel)       │   (邮件/短信)       │   (gRPC)   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 关键数据流

### 1. 区块链交易数据流

1. 区块链节点发现新区块
2. 通过ZMQ/WebSocket推送数据
3. 区块链适配器解析交易数据
4. 发送到Kafka的transactions主题
5. 交易分析引擎进行流处理
6. 风险评估引擎计算风险分数
7. 结果存储到PostgreSQL和OpenSearch
8. 触发告警（如需要）

### 2. 交易所监控数据流

1. 交易所通过API推送订单簿和交易数据
2. 交易所数据网关接收并验证数据
3. 发送到Kafka的exchange_data主题
4. 市场监控引擎应用规则
5. 检测异常交易模式
6. 生成监控报告
7. 触发干预措施（如需要）

### 3. 挖矿遥测数据流

1. 挖矿设备通过MQTT发送遥测数据
2. 设备通信协议解析数据
3. 发送到Kafka的mining_metrics主题
4. 能源管理系统计算消耗
5. 更新挖矿控制面板
6. 执行能源策略（如需要）

### 4. 审计日志数据流

1. 所有操作通过审计中间件
2. 生成审计日志条目
3. 计算日志哈希（链式结构）
4. 写入WORM存储
5. 同时发送到OpenSearch
6. 支持查询和导出

## 数据保留策略

| 数据类型 | 存储位置 | 保留期限 | 归档策略 |
|----------|----------|----------|----------|
| 交易记录 | PostgreSQL | 7年 | 归档到冷存储 |
| 审计日志 | WORM | 7年 | 永久保留 |
| 监控指标 | TimescaleDB | 90天 | 汇总后保留7年 |
| 系统日志 | OpenSearch | 365天 | 归档到对象存储 |

## 性能要求

- 交易处理: 10,000 TPS
- 交易所数据延迟: < 1秒
- 区块链同步延迟: < 30秒
- API响应时间: < 100ms
- 告警通知延迟: < 5秒
